<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>อนุมัติการจองรถ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', 'Kanit', sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .header-title {
            font-size: 28px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Roboto', 'Kanit', sans-serif;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-outline:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        /* Filter Section */
        .filter-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }
        
        .filter-select, .filter-input {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
            font-family: 'Roboto', 'Kanit', sans-serif;
            min-width: 180px;
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            text-align: center;
            border-top: 5px solid var(--primary);
        }
        
        .stat-card.pending {
            border-top-color: #f39c12;
        }
        
        .stat-card.approved {
            border-top-color: #2ecc71;
        }
        
        .stat-card.rejected {
            border-top-color: var(--danger);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 16px;
            color: var(--gray);
        }
        
        /* Approval List */
        .approval-list {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .list-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: var(--gray);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(67, 97, 238, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Approval Item */
        .approval-item {
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            transition: var(--transition);
        }
        
        .approval-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .approval-item.pending {
            border-left: 5px solid #f39c12;
        }
        
        .approval-item.approved {
            border-left: 5px solid #2ecc71;
            opacity: 0.7;
        }
        
        .approval-item.rejected {
            border-left: 5px solid var(--danger);
            opacity: 0.7;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-id {
            font-size: 14px;
            color: var(--gray);
            background-color: var(--gray-light);
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .item-date {
            font-size: 14px;
            color: var(--gray);
        }
        
        .item-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .item-field {
            display: flex;
            flex-direction: column;
        }
        
        .field-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .field-value {
            font-weight: 500;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: var(--gray);
        }
        
        .no-data i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .modal-message {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .header-actions {
                width: 100%;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-select, .filter-input {
                width: 100%;
            }
            
            .item-content {
                grid-template-columns: 1fr;
            }
            
            .item-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1 class="header-title">อนุมัติการจองรถ</h1>
                <p style="color: var(--gray); margin-top: 5px;">ตรวจสอบและอนุมัติคำขอจองรถ</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i>
                    กลับไป Dashboard
                </button>
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    รีเฟรชข้อมูล
                </button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-cards">
            <div class="stat-card pending">
                <div class="stat-label">รออนุมัติ</div>
                <div class="stat-value" id="pendingCount">0</div>
                <div style="font-size: 14px; color: var(--gray);">คำขอ</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-label">อนุมัติแล้ว</div>
                <div class="stat-value" id="approvedCount">0</div>
                <div style="font-size: 14px; color: var(--gray);">คำขอ</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-label">ปฏิเสธแล้ว</div>
                <div class="stat-value" id="rejectedCount">0</div>
                <div style="font-size: 14px; color: var(--gray);">คำขอ</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ทั้งหมด</div>
                <div class="stat-value" id="totalCount">0</div>
                <div style="font-size: 14px; color: var(--gray);">คำขอ</div>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">สถานะ</label>
                <select class="filter-select" id="filterStatus">
                    <option value="all">ทั้งหมด</option>
                    <option value="pending">รออนุมัติ</option>
                    <option value="approved">อนุมัติแล้ว</option>
                    <option value="rejected">ปฏิเสธแล้ว</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">วันที่จอง</label>
                <input type="date" class="filter-input" id="filterDate">
            </div>
            <div class="filter-group">
                <label class="filter-label">แผนก</label>
                <select class="filter-select" id="filterDepartment">
                    <option value="all">ทั้งหมด</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">รถ</label>
                <select class="filter-select" id="filterVehicle">
                    <option value="all">ทั้งหมด</option>
                </select>
            </div>
            <div style="flex-grow: 1;"></div>
            <button class="btn btn-outline" id="clearFilters">
                <i class="fas fa-times"></i>
                ล้างตัวกรอง
            </button>
        </div>
        
        <!-- Approval List -->
        <div class="approval-list">
            <div class="list-header">
                <div class="list-title">รายการคำขอจองรถ</div>
                <div style="color: var(--gray); font-size: 14px;">
                    แสดง <span id="showingCount">0</span> จากทั้งหมด <span id="totalShowing">0</span> รายการ
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>กำลังโหลดข้อมูล...</div>
            </div>
            
            <div id="approvalItemsContainer" style="display: none;">
                <!-- Approval items will be populated here -->
            </div>
            
            <div class="no-data" id="noData" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <h3>ไม่พบคำขอจองรถ</h3>
                <p>ไม่มีคำขอจองรถที่ตรงกับเงื่อนไขการค้นหา</p>
            </div>
        </div>
        
        <!-- Modal for confirmation -->
        <div class="modal" id="confirmModal">
            <div class="modal-content">
                <div class="modal-title" id="modalTitle">ยืนยันการอนุมัติ</div>
                <div class="modal-message" id="modalMessage">
                    คุณต้องการอนุมัติคำขอนี้หรือไม่?
                </div>
                <div class="modal-actions">
                    <button class="btn btn-outline" id="modalCancel">
                        ยกเลิก
                    </button>
                    <button class="btn btn-success" id="modalConfirm">
                        ตกลง
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Success Notification -->
        <div id="successNotification" style="display: none; position: fixed; top: 20px; right: 20px; background-color: #2ecc71; color: white; padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); z-index: 1000;">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage">ดำเนินการสำเร็จ</span>
        </div>
        
        <!-- Error Notification -->
        <div id="errorNotification" style="display: none; position: fixed; top: 20px; right: 20px; background-color: var(--danger); color: white; padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); z-index: 1000;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorMessage">เกิดข้อผิดพลาด</span>
        </div>
    </div>

    <script>
        // Google Apps Script URL (ใช้ตัวเดียวกับ Dashboard)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzcMdFcpQkAxIbb0iEJJfZ8fD0YgiGUetRkkw1UyMv7uY3tlza345UoL1uNrNbOUKRx/exec';
        
        // Global variables
        let allReservations = [];
        let filteredReservations = [];
        let currentAction = null; // 'approve' or 'reject'
        let currentReservationId = null;
        
        // DOM Elements
        const refreshBtn = document.getElementById('refreshBtn');
        const filterStatus = document.getElementById('filterStatus');
        const filterDate = document.getElementById('filterDate');
        const filterDepartment = document.getElementById('filterDepartment');
        const filterVehicle = document.getElementById('filterVehicle');
        const clearFilters = document.getElementById('clearFilters');
        const loading = document.getElementById('loading');
        const approvalItemsContainer = document.getElementById('approvalItemsContainer');
        const noData = document.getElementById('noData');
        
        // Stats elements
        const pendingCount = document.getElementById('pendingCount');
        const approvedCount = document.getElementById('approvedCount');
        const rejectedCount = document.getElementById('rejectedCount');
        const totalCount = document.getElementById('totalCount');
        const showingCount = document.getElementById('showingCount');
        const totalShowing = document.getElementById('totalShowing');
        
        // Modal elements
        const confirmModal = document.getElementById('confirmModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCancel = document.getElementById('modalCancel');
        const modalConfirm = document.getElementById('modalConfirm');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadReservations();
            
            // Event listeners
            refreshBtn.addEventListener('click', loadReservations);
            filterStatus.addEventListener('change', filterReservations);
            filterDate.addEventListener('change', filterReservations);
            filterDepartment.addEventListener('change', filterReservations);
            filterVehicle.addEventListener('change', filterReservations);
            clearFilters.addEventListener('click', clearAllFilters);
            
            modalCancel.addEventListener('click', closeModal);
            modalConfirm.addEventListener('click', executeAction);
            
            // Set today's date as default filter
            filterDate.valueAsDate = new Date();
        });
        
        // Load reservations from Google Sheets using JSONP
        function loadReservations() {
            showLoading();
            
            // สร้าง callback function ชื่อไม่ซ้ำ
            const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // กำหนด function สำหรับรับข้อมูล
            window[callbackName] = function(data) {
                // ลบ callback function ออกจาก window object
                delete window[callbackName];
                
                if (data && data.status === 'success' && data.data) {
                    allReservations = processReservations(data.data);
                    updateStats();
                    populateFilters();
                    filterReservations();
                    showSuccess('โหลดข้อมูลสำเร็จ');
                } else {
                    const errorMsg = data ? data.message : 'ไม่สามารถโหลดข้อมูลได้';
                    showError('ไม่สามารถโหลดข้อมูลได้: ' + errorMsg);
                    
                    // ลองโหลดจาก Google Sheets API แบบตรง
                    setTimeout(() => {
                        loadFromGoogleSheetsDirect();
                    }, 1000);
                }
                
                // ซ่อน loading
                loading.style.display = 'none';
            };
            
            // สร้าง script tag
            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?action=getAll&callback=${callbackName}`;
            
            // ตั้งค่า timeout
            script.onerror = function() {
                delete window[callbackName];
                showError('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้');
                loading.style.display = 'none';
                
                // ลองโหลดจาก Google Sheets API แบบตรง
                setTimeout(() => {
                    loadFromGoogleSheetsDirect();
                }, 1000);
            };
            
            // เพิ่ม script ไปยังหน้าเว็บ
            document.head.appendChild(script);
            
            // ลบ script หลังจาก 10 วินาที (ป้องกันไม่ลบ)
            setTimeout(() => {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }, 10000);
        }
        
        // โหลดจาก Google Sheets API โดยตรง (backup method)
        async function loadFromGoogleSheetsDirect() {
            try {
                const SHEET_ID = '1-5izB7N6ldxHAa3ca0RNhGP8Z36vuA0mw9Wi_xR_Lj4';
                const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
                
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                // Process CSV
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    throw new Error('No data in CSV');
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const processedData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const obj = { _row: i + 1 };
                    
                    headers.forEach((header, idx) => {
                        obj[header] = values[idx] || '';
                    });
                    
                    processedData.push(obj);
                }
                
                allReservations = processReservations(processedData);
                updateStats();
                populateFilters();
                filterReservations();
                showSuccess('โหลดข้อมูลสำเร็จ (จาก CSV)');
                
            } catch (error) {
                console.error('Error loading from CSV:', error);
                showError('ไม่สามารถโหลดข้อมูลได้จากแหล่งใดเลย');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Process reservations data
        function processReservations(data) {
            console.log('Processing data:', data.length, 'records');
            
            return data.map((item, index) => {
                // Get approval status from column N
                const approval = (item.approval || item.Approval || '').trim();
                
                // Determine status
                let status = 'pending';
                if (approval === 'อนุมัติ' || approval === 'approved' || approval === 'Approved') {
                    status = 'approved';
                } else if (approval === 'ปฏิเสธ' || approval === 'rejected' || approval === 'Rejected') {
                    status = 'rejected';
                }
                
                // Log for debugging
                if (index < 3) {
                    console.log(`Row ${item._row}: approval="${approval}" -> status=${status}`);
                }
                
                return {
                    id: index,
                    row: item._row || index + 2, // Google Sheets row number
                    code: item.Code || item.code || '',
                    name: item.name || item.Name || '',
                    section: item.section || item.Section || '',
                    department: item.department || item.Department || '',
                    position: item.position || item.Position || '',
                    contact: item.contact || item.Contact || '',
                    vehicle: item.choose || item.Choose || '',
                    startDate: item.rentStartdate || item.rentStartDate || '',
                    endDate: item.rentEnddate || item.rentEndDate || '',
                    startTime: item.startTime || '',
                    endTime: item.endTime || '',
                    reason: item.reason || item.Reason || '',
                    approval: approval,
                    status: status,
                    timestamp: item.Timestamp || item.timestamp || ''
                };
            });
        }
        
        // Update statistics
        function updateStats() {
            const pending = allReservations.filter(r => r.status === 'pending').length;
            const approved = allReservations.filter(r => r.status === 'approved').length;
            const rejected = allReservations.filter(r => r.status === 'rejected').length;
            const total = allReservations.length;
            
            pendingCount.textContent = pending;
            approvedCount.textContent = approved;
            rejectedCount.textContent = rejected;
            totalCount.textContent = total;
            
            console.log(`Stats: Pending=${pending}, Approved=${approved}, Rejected=${rejected}, Total=${total}`);
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            // Get unique departments
            const departments = [...new Set(allReservations.map(r => r.department).filter(Boolean))];
            const departmentSelect = document.getElementById('filterDepartment');
            
            departmentSelect.innerHTML = '<option value="all">ทั้งหมด</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
            
            // Get unique vehicles
            const vehicles = [...new Set(allReservations.map(r => r.vehicle).filter(Boolean))];
            const vehicleSelect = document.getElementById('filterVehicle');
            
            vehicleSelect.innerHTML = '<option value="all">ทั้งหมด</option>';
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle;
                option.textContent = vehicle;
                vehicleSelect.appendChild(option);
            });
        }
        
        // Filter reservations based on criteria
        function filterReservations() {
            const status = filterStatus.value;
            const date = filterDate.value;
            const department = filterDepartment.value;
            const vehicle = filterVehicle.value;
            
            filteredReservations = allReservations.filter(reservation => {
                // Filter by status
                if (status !== 'all' && reservation.status !== status) {
                    return false;
                }
                
                // Filter by date
                if (date) {
                    const reservationDate = new Date(reservation.startDate);
                    const filterDateObj = new Date(date);
                    
                    if (isNaN(reservationDate.getTime()) || 
                        reservationDate.toDateString() !== filterDateObj.toDateString()) {
                        return false;
                    }
                }
                
                // Filter by department
                if (department !== 'all' && reservation.department !== department) {
                    return false;
                }
                
                // Filter by vehicle
                if (vehicle !== 'all' && reservation.vehicle !== vehicle) {
                    return false;
                }
                
                return true;
            });
            
            displayReservations();
        }
        
        // Clear all filters
        function clearAllFilters() {
            filterStatus.value = 'all';
            filterDate.value = '';
            filterDepartment.value = 'all';
            filterVehicle.value = 'all';
            filterReservations();
        }
        
        // Display filtered reservations
        function displayReservations() {
            loading.style.display = 'none';
            
            if (filteredReservations.length === 0) {
                approvalItemsContainer.style.display = 'none';
                noData.style.display = 'block';
                showingCount.textContent = '0';
                totalShowing.textContent = allReservations.length;
                return;
            }
            
            noData.style.display = 'none';
            approvalItemsContainer.style.display = 'block';
            approvalItemsContainer.innerHTML = '';
            
            // Sort by timestamp (newest first)
            const sortedReservations = [...filteredReservations].sort((a, b) => {
                try {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA;
                } catch (e) {
                    return 0;
                }
            });
            
            sortedReservations.forEach(reservation => {
                const item = createReservationItem(reservation);
                approvalItemsContainer.appendChild(item);
            });
            
            showingCount.textContent = filteredReservations.length;
            totalShowing.textContent = allReservations.length;
        }
        
        // Create reservation item element
        function createReservationItem(reservation) {
            const item = document.createElement('div');
            item.className = `approval-item ${reservation.status}`;
            item.id = `reservation-${reservation.id}`;
            
            // Format date
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr.trim() === '') return 'ไม่ระบุ';
                try {
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return dateStr;
                    
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear() + 543; // Convert to Buddhist year
                    
                    return `${day}/${month}/${year}`;
                } catch (e) {
                    return dateStr;
                }
            };
            
            // Format time
            const formatTime = (timeStr) => {
                if (!timeStr || timeStr.trim() === '') return 'ไม่ระบุ';
                return timeStr;
            };
            
            const statusText = {
                'pending': 'รออนุมัติ',
                'approved': 'อนุมัติแล้ว',
                'rejected': 'ปฏิเสธแล้ว'
            }[reservation.status];
            
            const statusColor = {
                'pending': '#f39c12',
                'approved': '#2ecc71',
                'rejected': '#e74c3c'
            }[reservation.status];
            
            item.innerHTML = `
                <div class="item-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="item-id">#${reservation.code || reservation.row}</span>
                        <span style="color: ${statusColor}; font-weight: 500;">${statusText}</span>
                    </div>
                    <div class="item-date">${formatDate(reservation.timestamp)}</div>
                </div>
                
                <div class="item-content">
                    <div class="item-field">
                        <span class="field-label">ชื่อ-สกุล</span>
                        <span class="field-value">${reservation.name || '-'}</span>
                    </div>
                    <div class="item-field">
                        <span class="field-label">แผนก</span>
                        <span class="field-value">${reservation.department || '-'}</span>
                    </div>
                    <div class="item-field">
                        <span class="field-label">ตำแหน่ง</span>
                        <span class="field-value">${reservation.position || '-'}</span>
                    </div>
                    <div class="item-field">
                        <span class="field-label">รถที่จอง</span>
                        <span class="field-value">${reservation.vehicle || '-'}</span>
                    </div>
                    <div class="item-field">
                        <span class="field-label">วันที่จอง</span>
                        <span class="field-value">${formatDate(reservation.startDate)} - ${formatDate(reservation.endDate)}</span>
                    </div>
                    <div class="item-field">
                        <span class="field-label">เวลา</span>
                        <span class="field-value">${formatTime(reservation.startTime)} - ${formatTime(reservation.endTime)}</span>
                    </div>
                </div>
                
                <div class="item-field" style="margin-bottom: 15px;">
                    <span class="field-label">เหตุผลการจอง</span>
                    <span class="field-value">${reservation.reason || 'ไม่ระบุ'}</span>
                </div>
            `;
            
            // Add action buttons (only for pending reservations)
            if (reservation.status === 'pending') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'item-actions';
                
                actionsDiv.innerHTML = `
                    <button class="btn btn-success btn-sm" onclick="showApproveConfirm(${reservation.id})">
                        <i class="fas fa-check"></i> อนุมัติ
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="showRejectConfirm(${reservation.id})">
                        <i class="fas fa-times"></i> ปฏิเสธ
                    </button>
                `;
                
                item.appendChild(actionsDiv);
            }
            
            return item;
        }
        
        // Show loading
        function showLoading() {
            loading.style.display = 'flex';
            approvalItemsContainer.style.display = 'none';
            noData.style.display = 'none';
        }
        
        // Show approve confirmation
        function showApproveConfirm(reservationId) {
            currentAction = 'approve';
            currentReservationId = reservationId;
            
            const reservation = allReservations.find(r => r.id === reservationId);
            
            modalTitle.textContent = 'ยืนยันการอนุมัติ';
            modalMessage.innerHTML = `
                คุณต้องการอนุมัติคำขอนี้หรือไม่?<br><br>
                <strong>ข้อมูลการจอง:</strong><br>
                • ชื่อ: ${reservation.name || '-'}<br>
                • รถ: ${reservation.vehicle || '-'}<br>
                • วันที่: ${reservation.startDate || '-'}<br>
                • เหตุผล: ${reservation.reason || 'ไม่ระบุ'}
            `;
            
            confirmModal.style.display = 'flex';
        }
        
        // Show reject confirmation
        function showRejectConfirm(reservationId) {
            currentAction = 'reject';
            currentReservationId = reservationId;
            
            const reservation = allReservations.find(r => r.id === reservationId);
            
            modalTitle.textContent = 'ยืนยันการปฏิเสธ';
            modalMessage.innerHTML = `
                คุณต้องการปฏิเสธคำขอนี้หรือไม่?<br><br>
                <strong>ข้อมูลการจอง:</strong><br>
                • ชื่อ: ${reservation.name || '-'}<br>
                • รถ: ${reservation.vehicle || '-'}<br>
                • วันที่: ${reservation.startDate || '-'}<br>
                • เหตุผล: ${reservation.reason || 'ไม่ระบุ'}
            `;
            
            confirmModal.style.display = 'flex';
        }
        
        // Close modal
        function closeModal() {
            confirmModal.style.display = 'none';
            currentAction = null;
            currentReservationId = null;
        }
        
        // Execute approve/reject action
        async function executeAction() {
            try {
                const reservation = allReservations.find(r => r.id === currentReservationId);
                
                if (!reservation) {
                    throw new Error('ไม่พบข้อมูลการจอง');
                }
                
                let newStatus, thaiStatus, actionText;
                
                if (currentAction === 'approve') {
                    newStatus = 'อนุมัติ';
                    thaiStatus = 'อนุมัติแล้ว';
                    actionText = 'อนุมัติ';
                } else {
                    newStatus = 'ปฏิเสธ';
                    thaiStatus = 'ปฏิเสธแล้ว';
                    actionText = 'ปฏิเสธ';
                }
                
                // สร้าง form สำหรับส่งข้อมูล (ใช้วิธี POST ผ่าน iframe)
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'updateApproval';
                
                const rowInput = document.createElement('input');
                rowInput.type = 'hidden';
                rowInput.name = 'row';
                rowInput.value = reservation.row;
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                statusInput.value = newStatus;
                
                form.appendChild(actionInput);
                form.appendChild(rowInput);
                form.appendChild(statusInput);
                document.body.appendChild(form);
                
                // สร้าง iframe ซ่อนไว้สำหรับรับ response
                const iframe = document.createElement('iframe');
                iframe.name = 'hiddenFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                // ส่ง form
                form.submit();
                
                // ลบ form และ iframe หลังจากส่ง
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);
                
                // Update local data
                reservation.approval = newStatus;
                reservation.status = currentAction === 'approve' ? 'approved' : 'rejected';
                
                // Update UI
                updateStats();
                filterReservations();
                
                showSuccess(`ดำเนินการ${actionText}สำเร็จ`);
                closeModal();
                
            } catch (error) {
                console.error('Error updating approval:', error);
                showError('ไม่สามารถดำเนินการได้: ' + error.message);
                closeModal();
            }
        }
        
        // Show success notification
        function showSuccess(message) {
            const notification = document.getElementById('successNotification');
            const messageEl = document.getElementById('successMessage');
            
            messageEl.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Show error notification
        function showError(message) {
            const notification = document.getElementById('errorNotification');
            const messageEl = document.getElementById('errorMessage');
            
            messageEl.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // ฟังก์ชันช่วยสำหรับการ debug
        window.debugData = function() {
            console.log('All reservations:', allReservations);
            console.log('Filtered reservations:', filteredReservations);
        };
    </script>
</body>
</html>
