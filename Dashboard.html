<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Car Rent Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { background:#f4f6f9; }
.card { border-radius:10px; }
.no-print { display:inline-block; }
.summary { font-size:20px; font-weight:bold; }
</style>
</head>

<body onload="loadData()">
<div class="container my-4" id="pdfContent">

<h4 class="text-center mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô)</h4>

<div class="row text-center mb-3">
  <div class="col card p-2">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<br><span id="sumTotal" class="summary"></span></div>
  <div class="col card p-2 bg-warning-subtle">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br><span id="sumPending" class="summary"></span></div>
  <div class="col card p-2 bg-success-subtle">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥<br><span id="sumApproved" class="summary"></span></div>
  <div class="col card p-2 bg-danger-subtle">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò<br><span id="sumRejected" class="summary"></span></div>
</div>

<table class="table table-bordered table-sm bg-white">
<thead class="table-light">
<tr>
<th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏£‡∏ñ</th>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<p class="mt-4 small">
‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ______________________ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ____ / ____ / ______
</p>

</div>

<div class="text-center mb-4">
<button class="btn btn-danger no-print" onclick="exportPDF()">üìÑ Export PDF</button>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzcMdFcpQkAxIbb0iEJJfZ8fD0YgiGUetRkkw1UyMv7uY3tlza345UoL1uNrNbOUKRx/exec";
let data = [];

async function loadData() {
  const res = await fetch(API);
  const json = await res.json();
  const rows = json.data;
  rows.shift();

  data = rows.map((r,i)=>({
    row:i+2,name:r[2],dept:r[4],car:r[7],
    date:`${r[8]} - ${r[9]}`,reason:r[12],
    approval:r[13]||"‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
  }));

  render();
}

function render() {
  tbody.innerHTML="";
  let p=0,a=0,r=0;

  data.forEach(d=>{
    if(d.approval==="‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥")p++;
    if(d.approval==="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥")a++;
    if(d.approval==="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò")r++;

    tbody.innerHTML+=`
<tr>
<td>${d.name}</td>
<td>${d.dept}</td>
<td>${d.car}</td>
<td>${d.date}</td>
<td>${d.reason||"-"}</td>
<td>${d.approval}</td>
<td>
<button class="btn btn-success btn-sm" onclick="setStatus(${d.row},'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')">‚úî</button>
<button class="btn btn-danger btn-sm" onclick="reject(${d.row})">‚úñ</button>
</td>
</tr>`;
  });

  sumTotal.innerText=data.length;
  sumPending.innerText=p;
  sumApproved.innerText=a;
  sumRejected.innerText=r;
}

async function setStatus(row,st,note="") {
  await fetch(API,{method:"POST",body:JSON.stringify({
    rowIndex:row,approval:st,approver:"‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô",note
  })});
  loadData();
}

function reject(row){
  const note=prompt("‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
  if(note!==null)setStatus(row,"‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò",note);
}

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(pdfContent,{scale:2});
  const pdf = new jsPDF("p","mm","a4");
  const w = pdf.internal.pageSize.getWidth();
  const h = canvas.height * w / canvas.width;
  pdf.addImage(canvas.toDataURL(),"PNG",0,0,w,h);
  pdf.save("Car_Rent_Report.pdf");
}
</script>

</body>
</html>
