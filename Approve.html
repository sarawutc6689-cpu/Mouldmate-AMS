<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบอนุมัติการจองรถ - Car Rent Approval</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2a5298;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
            flex: 1;
        }
        
        .filter-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2a5298;
        }
        
        select, input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .status-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .status-badge.active {
            background-color: #2a5298;
            color: white;
        }
        
        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-badge.approved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-badge.rejected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #2a5298;
        }
        
        .reservations-container {
            margin-top: 30px;
        }
        
        .reservation-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #ffc107;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .reservation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .reservation-card.approved {
            border-left-color: #28a745;
        }
        
        .reservation-card.rejected {
            border-left-color: #dc3545;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .reservation-code {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2a5298;
            background-color: #eef2ff;
            padding: 5px 15px;
            border-radius: 4px;
        }
        
        .reservation-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .card-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-group {
            margin-bottom: 10px;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .timestamp {
            font-size: 0.85rem;
            color: #888;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-approve {
            background-color: #28a745;
            color: white;
        }
        
        .btn-approve:hover {
            background-color: #218838;
        }
        
        .btn-reject {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-reject:hover {
            background-color: #c82333;
        }
        
        .btn-view {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-view:hover {
            background-color: #138496;
        }
        
        .btn-refresh {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-refresh:hover {
            background-color: #5a6268;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #2a5298;
        }
        
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .reason-text {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            line-height: 1.8;
        }
        
        .approval-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background-color: #28a745;
        }
        
        .notification.error {
            background-color: #dc3545;
        }
        
        .header-controls {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .card-content {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .card-footer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: flex-start;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .header-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-car"></i>
                <div>
                    <h1>ระบบอนุมัติการจองรถ</h1>
                    <p class="subtitle">Car Rent Approval System</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="btn btn-refresh" id="btnRefresh">
                    <i class="fas fa-sync-alt"></i> โหลดข้อมูลใหม่
                </button>
            </div>
        </header>
        
        <div class="content">
            <div class="filters">
                <div class="filter-group">
                    <label for="departmentFilter">ฝ่าย/แผนก</label>
                    <select id="departmentFilter">
                        <option value="">ทั้งหมด</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="dateFilter">วันที่จอง</label>
                    <input type="date" id="dateFilter">
                </div>
                
                <div class="filter-group">
                    <label>สถานะ</label>
                    <div class="status-badges">
                        <div class="status-badge pending active" data-status="">ทั้งหมด</div>
                        <div class="status-badge pending" data-status="รออนุมัติ">รออนุมัติ</div>
                        <div class="status-badge approved" data-status="อนุมัติแล้ว">อนุมัติแล้ว</div>
                        <div class="status-badge rejected" data-status="ไม่อนุมัติ">ไม่อนุมัติ</div>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>กำลังโหลดข้อมูลการจองรถจาก Google Sheets...</p>
            </div>
            
            <div id="reservationsContainer" class="reservations-container" style="display: none;">
                <!-- ข้อมูลการจองจะแสดงที่นี่ -->
            </div>
        </div>
    </div>
    
    <!-- Modal สำหรับดูรายละเอียด -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">รายละเอียดการจองรถ</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="card-content">
                    <div class="info-group">
                        <div class="info-label">รหัสการจอง</div>
                        <div id="modalCode" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ชื่อ-สกุล</div>
                        <div id="modalName" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ฝ่าย/แผนก/ส่วน</div>
                        <div id="modalDepartment" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ตำแหน่ง</div>
                        <div id="modalPosition" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ประเภทรถ</div>
                        <div id="modalVehicle" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">วันที่เริ่มจอง</div>
                        <div id="modalStartDate" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">วันที่สิ้นสุดการจอง</div>
                        <div id="modalEndDate" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">เวลาเริ่มต้น</div>
                        <div id="modalStartTime" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">เวลาสิ้นสุด</div>
                        <div id="modalEndTime" class="info-value">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ติดต่อ</div>
                        <div id="modalContact" class="info-value">-</div>
                    </div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">วัตถุประสงค์</div>
                    <div id="modalReason" class="reason-text">-</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">สถานะการอนุมัติ</div>
                    <div id="modalApproval" class="info-value">-</div>
                </div>
                
                <div class="approval-form" id="approvalFormSection">
                    <div class="form-group">
                        <label for="approvalNote">หมายเหตุ (หากต้องการ)</label>
                        <textarea id="approvalNote" placeholder="ระบุหมายเหตุสำหรับการอนุมัติหรือไม่อนุมัติ..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-reject" id="btnRejectModal">
                    <i class="fas fa-times"></i> ไม่อนุมัติ
                </button>
                <button class="btn btn-approve" id="btnApproveModal">
                    <i class="fas fa-check"></i> อนุมัติ
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <script>
        // URL ของ Google Apps Script
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwXdewp18aX-fXK3_LxVCpbhZ2ROJqig186DzUu_GzjU5UqcPT_hut_rNKu8DBUsXX-/exec';
        
        // ตัวแปรเก็บข้อมูลการจอง
        let reservations = [];
        let currentReservation = null;
        let callbackId = 0;
        
        // โหลดข้อมูลจาก Google Sheets เมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', function() {
            loadReservationsFromGoogleSheets();
            
            // เพิ่ม event listeners
            document.getElementById('departmentFilter').addEventListener('change', filterReservations);
            document.getElementById('dateFilter').addEventListener('change', filterReservations);
            document.getElementById('btnRefresh').addEventListener('click', loadReservationsFromGoogleSheets);
            
            // สถานะ filter
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.addEventListener('click', function() {
                    document.querySelectorAll('.status-badge').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterReservations();
                });
            });
            
            // Modal close
            document.querySelector('.close-modal').addEventListener('click', closeModal);
            document.getElementById('btnApproveModal').addEventListener('click', approveReservation);
            document.getElementById('btnRejectModal').addEventListener('click', rejectReservation);
        });
        
        // ฟังก์ชันโหลดข้อมูลการจองจาก Google Sheets โดยใช้ JSONP
        function loadReservationsFromGoogleSheets() {
            showLoading(true);
            
            // สร้าง callback function สำหรับ JSONP
            callbackId++;
            const callbackName = `jsonpCallback_${callbackId}`;
            
            // กำหนด global callback function
            window[callbackName] = function(data) {
                try {
                    // ลบ callback function ออกจาก window object
                    delete window[callbackName];
                    
                    // ลบ script element
                    document.getElementById('jsonpScript')?.remove();
                    
                    // ประมวลผลข้อมูล
                    processReservationsData(data);
                } catch (error) {
                    console.error('Error in JSONP callback:', error);
                    showLoading(false, true);
                    showNotification('เกิดข้อผิดพลาดในการประมวลผลข้อมูล', 'error');
                }
            };
            
            // สร้าง script element สำหรับ JSONP
            const script = document.createElement('script');
            script.id = 'jsonpScript';
            script.src = `${scriptUrl}?callback=${callbackName}`;
            script.onerror = function() {
                showLoading(false, true);
                showNotification('ไม่สามารถเชื่อมต่อกับ Google Sheets ได้', 'error');
                document.getElementById('jsonpScript')?.remove();
                delete window[callbackName];
            };
            
            // เพิ่ม script ไปยัง document
            document.head.appendChild(script);
            
            // ตั้งค่า timeout
            setTimeout(() => {
                if (document.getElementById('jsonpScript')) {
                    showLoading(false, true);
                    showNotification('การเชื่อมต่อใช้งานเวลานานเกินไป', 'error');
                    document.getElementById('jsonpScript')?.remove();
                    delete window[callbackName];
                }
            }, 10000); // timeout 10 วินาที
        }
        
        // ประมวลผลข้อมูลที่ได้จาก JSONP
        function processReservationsData(data) {
            try {
                // ตรวจสอบว่าได้ข้อมูลมาหรือไม่
                if (!data || !Array.isArray(data)) {
                    throw new Error('รูปแบบข้อมูลไม่ถูกต้อง');
                }
                
                // แปลงข้อมูลให้ตรงกับโครงสร้าง
                reservations = data.map(item => {
                    // สร้าง object ที่มี property ตามโครงสร้างคอลัมน์
                    // ถ้าข้อมูลเป็น array of arrays
                    if (Array.isArray(item)) {
                        return {
                            Timestamp: item[0] || '',
                            Code: item[1] || '',
                            name: item[2] || '',
                            section: item[3] || '',
                            department: item[4] || '',
                            position: item[5] || '',
                            contact: item[6] || '',
                            choose: item[7] || '',
                            rentStartdate: item[8] || '',
                            rentEnddate: item[9] || '',
                            startTime: item[10] || '',
                            endTime: item[11] || '',
                            reason: item[12] || '',
                            approval: item[13] || 'รออนุมัติ'
                        };
                    } 
                    // ถ้าข้อมูลเป็น array of objects
                    else if (typeof item === 'object') {
                        return {
                            Timestamp: item.Timestamp || item.A || item[0] || '',
                            Code: item.Code || item.B || item[1] || '',
                            name: item.name || item.C || item[2] || '',
                            section: item.section || item.D || item[3] || '',
                            department: item.department || item.E || item[4] || '',
                            position: item.position || item.F || item[5] || '',
                            contact: item.contact || item.G || item[6] || '',
                            choose: item.choose || item.H || item[7] || '',
                            rentStartdate: item.rentStartdate || item.I || item[8] || '',
                            rentEnddate: item.rentEnddate || item.J || item[9] || '',
                            startTime: item.startTime || item.K || item[10] || '',
                            endTime: item.endTime || item.L || item[11] || '',
                            reason: item.reason || item.M || item[12] || '',
                            approval: item.approval || item.N || item[13] || 'รออนุมัติ'
                        };
                    }
                    return {};
                }).filter(item => item.Code); // กรองเฉพาะที่มีรหัสการจอง
                
                // เรียงลำดับตามวันที่ส่งคำขอ (ใหม่สุดก่อน)
                reservations.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                
                // ซ่อน loading และแสดง container
                showLoading(false);
                
                // แสดงข้อมูลการจอง
                displayReservations(reservations);
                
                // เติมข้อมูลใน filter
                populateDepartmentFilter();
                
                // กรองข้อมูล
                filterReservations();
                
                // แสดง notification สำเร็จ
                showNotification(`โหลดข้อมูลการจองเรียบร้อยแล้ว (${reservations.length} รายการ)`, 'success');
                
            } catch (error) {
                console.error('Error processing data:', error);
                showLoading(false, true);
                
                // แสดงข้อผิดพลาด
                document.getElementById('reservationsContainer').innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                        <p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                        <p>${error.message}</p>
                        <p style="margin-top: 20px;">
                            <button class="btn btn-refresh" onclick="loadReservationsFromGoogleSheets()">
                                <i class="fas fa-redo"></i> ลองใหม่อีกครั้ง
                            </button>
                        </p>
                    </div>
                `;
                
                showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
            }
        }
        
        // แสดงหรือซ่อน loading
        function showLoading(show, error = false) {
            const loadingElement = document.getElementById('loading');
            const containerElement = document.getElementById('reservationsContainer');
            
            if (show) {
                loadingElement.style.display = 'block';
                containerElement.style.display = 'none';
                
                if (error) {
                    loadingElement.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                    `;
                } else {
                    loadingElement.innerHTML = `
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>กำลังโหลดข้อมูลการจองรถจาก Google Sheets...</p>
                    `;
                }
            } else {
                loadingElement.style.display = 'none';
                containerElement.style.display = 'block';
            }
        }
        
        // แสดงข้อมูลการจองในหน้าเว็บ
        function displayReservations(reservationsToShow) {
            const container = document.getElementById('reservationsContainer');
            
            if (reservationsToShow.length === 0) {
                container.innerHTML = '<div class="no-data">ไม่พบข้อมูลการจองรถ</div>';
                return;
            }
            
            let html = '';
            
            reservationsToShow.forEach(reservation => {
                // กำหนดคลาสสถานะ
                let statusClass = '';
                let statusText = reservation.approval || 'รออนุมัติ';
                
                if (statusText === 'อนุมัติแล้ว') {
                    statusClass = 'approved';
                } else if (statusText === 'ไม่อนุมัติ') {
                    statusClass = 'rejected';
                } else {
                    statusClass = 'pending';
                    statusText = 'รออนุมัติ';
                }
                
                // แสดงข้อมูลฝ่าย/แผนก/ส่วน
                const departmentInfo = `${reservation.department || ''}${reservation.section ? ' / ' + reservation.section : ''}`;
                
                html += `
                <div class="reservation-card ${statusClass}" data-code="${reservation.Code}">
                    <div class="card-header">
                        <div class="reservation-code">${reservation.Code || 'ไม่มีรหัส'}</div>
                        <div class="reservation-status ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="card-content">
                        <div class="info-group">
                            <div class="info-label">ชื่อ-สกุล</div>
                            <div class="info-value">${reservation.name || '-'}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">ฝ่าย/แผนก/ส่วน</div>
                            <div class="info-value">${departmentInfo || '-'}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">ตำแหน่ง</div>
                            <div class="info-value">${reservation.position || '-'}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">วันที่เริ่มจอง</div>
                            <div class="info-value">${formatDate(reservation.rentStartdate)}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">วันที่สิ้นสุด</div>
                            <div class="info-value">${formatDate(reservation.rentEnddate)}</div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-label">ประเภทรถ</div>
                            <div class="info-value">${reservation.choose || '-'}</div>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <div class="timestamp">ส่งคำขอก่อนหน้า: ${formatDateTime(reservation.Timestamp)}</div>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewReservationDetails('${reservation.Code}')">
                                <i class="fas fa-eye"></i> ดูรายละเอียด
                            </button>
                            
                            ${statusText === 'รออนุมัติ' ? `
                            <button class="btn btn-approve" onclick="approveReservationFromCard('${reservation.Code}')">
                                <i class="fas fa-check"></i> อนุมัติ
                            </button>
                            <button class="btn btn-reject" onclick="rejectReservationFromCard('${reservation.Code}')">
                                <i class="fas fa-times"></i> ไม่อนุมัติ
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // กรองข้อมูลการจองตาม filter
        function filterReservations() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.querySelector('.status-badge.active').dataset.status;
            
            let filtered = reservations;
            
            // กรองตามฝ่าย/แผนก
            if (departmentFilter) {
                filtered = filtered.filter(reservation => 
                    reservation.department === departmentFilter || 
                    reservation.section === departmentFilter
                );
            }
            
            // กรองตามวันที่
            if (dateFilter) {
                filtered = filtered.filter(reservation => {
                    const startDate = reservation.rentStartdate;
                    const endDate = reservation.rentEnddate;
                    
                    if (!startDate || !endDate) return false;
                    
                    // ตรวจสอบว่าวันที่กรองอยู่ระหว่างวันที่เริ่มและสิ้นสุดหรือไม่
                    return dateFilter >= startDate && dateFilter <= endDate;
                });
            }
            
            // กรองตามสถานะ
            if (statusFilter) {
                filtered = filtered.filter(reservation => {
                    const approvalStatus = reservation.approval || 'รออนุมัติ';
                    return approvalStatus === statusFilter;
                });
            }
            
            displayReservations(filtered);
        }
        
        // เติมข้อมูลใน filter ฝ่าย/แผนก
        function populateDepartmentFilter() {
            const departments = new Set();
            const sections = new Set();
            
            reservations.forEach(reservation => {
                if (reservation.department) departments.add(reservation.department);
                if (reservation.section) sections.add(reservation.section);
            });
            
            const select = document.getElementById('departmentFilter');
            
            // ล้าง options เดิม (เหลือแค่ option "ทั้งหมด")
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // เพิ่ม departments
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = `ฝ่าย/แผนก: ${dept}`;
                select.appendChild(option);
            });
            
            // เพิ่ม sections
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = `ส่วน: ${section}`;
                select.appendChild(option);
            });
        }
        
        // ดูรายละเอียดการจอง
        function viewReservationDetails(code) {
            const reservation = reservations.find(r => r.Code === code);
            if (!reservation) {
                showNotification('ไม่พบข้อมูลการจองนี้', 'error');
                return;
            }
            
            currentReservation = reservation;
            
            // แสดงข้อมูลฝ่าย/แผนก/ส่วน
            const departmentInfo = `${reservation.department || ''}${reservation.section ? ' / ' + reservation.section : ''}`;
            
            // เติมข้อมูลใน modal
            document.getElementById('modalCode').textContent = reservation.Code || '-';
            document.getElementById('modalName').textContent = reservation.name || '-';
            document.getElementById('modalDepartment').textContent = departmentInfo || '-';
            document.getElementById('modalPosition').textContent = reservation.position || '-';
            document.getElementById('modalVehicle').textContent = reservation.choose || '-';
            document.getElementById('modalStartDate').textContent = formatDate(reservation.rentStartdate);
            document.getElementById('modalEndDate').textContent = formatDate(reservation.rentEnddate);
            document.getElementById('modalStartTime').textContent = reservation.startTime || '-';
            document.getElementById('modalEndTime').textContent = reservation.endTime || '-';
            document.getElementById('modalContact').textContent = reservation.contact || '-';
            document.getElementById('modalReason').textContent = reservation.reason || '-';
            
            // แสดงสถานะการอนุมัติ
            const approvalStatus = reservation.approval || 'รออนุมัติ';
            document.getElementById('modalApproval').textContent = approvalStatus;
            document.getElementById('modalApproval').className = `info-value ${getStatusClass(approvalStatus)}`;
            
            // ซ่อน/แสดงปุ่มอนุมัติตามสถานะ
            const approvalFormSection = document.getElementById('approvalFormSection');
            const modalFooter = document.querySelector('.modal-footer');
            
            if (approvalStatus === 'รออนุมัติ') {
                approvalFormSection.style.display = 'block';
                modalFooter.style.display = 'flex';
            } else {
                approvalFormSection.style.display = 'none';
                modalFooter.style.display = 'none';
            }
            
            // ล้าง note
            document.getElementById('approvalNote').value = '';
            
            // แสดง modal
            document.getElementById('detailModal').style.display = 'flex';
        }
        
        // ฟังก์ชันช่วยเหลือ: ได้คลาสสถานะจากข้อความสถานะ
        function getStatusClass(status) {
            if (status === 'อนุมัติแล้ว') return 'approved';
            if (status === 'ไม่อนุมัติ') return 'rejected';
            return 'pending';
        }
        
        // ปิด modal
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentReservation = null;
        }
        
        // อนุมัติการจองจาก modal
        function approveReservation() {
            if (!currentReservation) return;
            
            const note = document.getElementById('approvalNote').value;
            updateApprovalStatus(currentReservation.Code, 'อนุมัติแล้ว', note);
        }
        
        // ไม่อนุมัติการจองจาก modal
        function rejectReservation() {
            if (!currentReservation) return;
            
            const note = document.getElementById('approvalNote').value;
            updateApprovalStatus(currentReservation.Code, 'ไม่อนุมัติ', note);
        }
        
        // อนุมัติการจองจาก card
        function approveReservationFromCard(code) {
            if (confirm('คุณต้องการอนุมัติการจองนี้ใช่หรือไม่?')) {
                updateApprovalStatus(code, 'อนุมัติแล้ว');
            }
        }
        
        // ไม่อนุมัติการจองจาก card
        function rejectReservationFromCard(code) {
            if (confirm('คุณต้องการไม่อนุมัติการจองนี้ใช่หรือไม่?')) {
                updateApprovalStatus(code, 'ไม่อนุมัติ');
            }
        }
        
        // อัพเดทสถานะการอนุมัติ
        async function updateApprovalStatus(code, status, note = '') {
            try {
                // สร้าง form สำหรับส่งข้อมูล (ใช้วิธีแบบฟอร์มเพื่อหลีกเลี่ยง CORS)
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = scriptUrl;
                form.target = '_blank'; // เปิดในหน้าต่างใหม่เพื่อหลีกเลี่ยง CORS
                form.style.display = 'none';
                
                // สร้าง input fields
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'update';
                
                const codeInput = document.createElement('input');
                codeInput.type = 'hidden';
                codeInput.name = 'code';
                codeInput.value = code;
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                statusInput.value = status;
                
                const noteInput = document.createElement('input');
                noteInput.type = 'hidden';
                noteInput.name = 'note';
                noteInput.value = note || '';
                
                // เพิ่ม input fields ไปยังฟอร์ม
                form.appendChild(actionInput);
                form.appendChild(codeInput);
                form.appendChild(statusInput);
                form.appendChild(noteInput);
                
                // เพิ่มฟอร์มไปยัง document และ submit
                document.body.appendChild(form);
                form.submit();
                
                // ลบฟอร์มหลังจาก submit
                setTimeout(() => {
                    document.body.removeChild(form);
                }, 100);
                
                // อัพเดทข้อมูลใน array ทันที (optimistic update)
                const index = reservations.findIndex(r => r.Code === code);
                if (index !== -1) {
                    reservations[index].approval = status;
                    
                    // อัพเดทการแสดงผล
                    filterReservations();
                    
                    // ปิด modal
                    closeModal();
                    
                    // แสดง notification
                    showNotification(`อัพเดทสถานะการจอง ${code} เป็น "${status}" เรียบร้อยแล้ว`, 'success');
                    
                    // รีเฟรชข้อมูลหลังจากอัพเดท
                    setTimeout(() => {
                        loadReservationsFromGoogleSheets();
                    }, 2000);
                }
            } catch (error) {
                console.error('Error updating approval status:', error);
                showNotification('เกิดข้อผิดพลาดในการอัพเดทสถานะ', 'error');
            }
        }
        
        // แสดง notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // จัดรูปแบบวันที่
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                // แปลงรูปแบบวันที่จาก YYYY-MM-DD
                const [year, month, day] = dateString.split('-');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        // จัดรูปแบบวันที่และเวลา
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            try {
                const date = new Date(dateTimeString);
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateTimeString;
            }
        }
        
        // ปิด modal เมื่อคลิกนอกเนื้อหา
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>
